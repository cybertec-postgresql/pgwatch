
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pgwatch.com/docs/custom_installation/">
      
      
        <link rel="prev" href="../docker_installation/">
      
      
        <link rel="next" href="../preparing_databases/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.29">
    
    
      
        <title>Custom installation - pgwatch3 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.76a95c52.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#config-db-based-setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pgwatch3 Documentation" class="md-header__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pgwatch3 Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Custom installation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pgwatch3 Documentation" class="md-nav__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pgwatch3 Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../project_background/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project Background
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced_features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation_options/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation Options
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker_installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Custom Installation
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../preparing_databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preparing Databases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../using_managed_services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Managed Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metric_definitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metric Definitions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../web_ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web UI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboarding_alerting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashboarding and Alerting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sizing_recommendations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sizing Recommendations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../technical_details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical Details
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../long_term_installations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Long Term Installations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrading
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>As described in the <code>Components &lt;components&gt;</code>{.interpreted-text
role="ref"} chapter, there a couple of ways how to set up up pgwatch3.
Two most common ways though are the central <em>Config DB</em> based "pull"
approach and the <em>YAML file</em> based "push" approach, plus Grafana to
visualize the gathered metrics.</p>
<h1 id="config-db-based-setup">Config DB based setup</h1>
<p><strong>Overview of installation steps</strong></p>
<ol>
<li>Install Postgres or use any available existing instance - v9.4+
    required for the config DB and v11+ for the metrics DB.</li>
<li>Bootstrap the Config DB.</li>
<li>Bootstrap the metrics storage DB (PostgreSQL here).</li>
<li>Install pgwatch3 - either from pre-built packages or by compiling
    the Go code.</li>
<li>Prepare the "to-be-monitored" databases for monitoring by creating
    a dedicated login role name as a minimum.</li>
<li>Optional step - install the administrative Web UI + Python &amp; library
    dependencies.</li>
<li>Add some databases to the monitoring configuration via the Web UI or
    directly in the Config DB.</li>
<li>Start the pgwatch3 metrics collection agent and monitor the logs for
    any problems.</li>
<li>Install and configure Grafana and import the pgwatch3 sample
    dashboards to start analyzing the metrics.</li>
<li>Make sure that there are auto-start SystemD services for all
    components in place and optionally set up also backups.</li>
</ol>
<p><strong>Detailed steps for the Config DB based "pull" approach with Postgres
metrics storage</strong></p>
<p>Below are sample steps to do a custom install from scratch using
Postgres for the pgwatch3 configuration DB, metrics DB and Grafana
config DB.</p>
<p>All examples here assume Ubuntu as OS - but it's basically the same for
RedHat family of operations systems also, minus package installation
syntax differences.</p>
<ol>
<li>
<p><strong>Install Postgres</strong></p>
<p>Follow the standard Postgres install procedure basically. Use the
latest major version available, but minimally v11+ is recommended
for the metrics DB due to recent partitioning speedup improvements
and also older versions were missing some default JSONB casts so
that a few built-in Grafana dashboards need adjusting otherwise.</p>
<p>To get the latest Postgres versions, official Postgres PGDG repos
are to be preferred over default disto repos. Follow the
instructions from:</p>
<ul>
<li><a href="https://wiki.postgresql.org/wiki/Apt">https://wiki.postgresql.org/wiki/Apt</a> - for Debian / Ubuntu
    based systems</li>
<li><a href="https://www.postgresql.org/download/linux/redhat/">https://www.postgresql.org/download/linux/redhat/</a> - for CentOS
    / RedHat based systems</li>
</ul>
</li>
<li>
<p><strong>Install pgwatch3</strong> - either from pre-built packages or by
    compiling the Go code</p>
<ul>
<li>
<p>Using pre-built packages</p>
<p>The pre-built DEB / RPM / Tar packages are available on the
<a href="https://github.com/cybertec-postgresql/pgwatch3/releases">Github
releases</a>
page.</p>
<pre><code># find out the latest package link and replace below, using v1.8.0 here
wget https://github.com/cybertec-postgresql/pgwatch3/releases/download/v1.8.0/pgwatch3_v1.8.0-SNAPSHOT-064fdaf_linux_64-bit.deb
sudo dpkg -i pgwatch3_v1.8.0-SNAPSHOT-064fdaf_linux_64-bit.deb
</code></pre>
</li>
<li>
<p>Compiling the Go code yourself</p>
<p>This method of course is not needed unless dealing with maximum
security environments or some slight code changes are required.</p>
<ol>
<li>
<p>Install Go by following the <a href="https://golang.org/doc/install">official
    instructions</a></p>
</li>
<li>
<p>Get the pgwatch3 project's code and compile the gatherer
    daemon</p>
<pre><code>git clone https://github.com/cybertec-postgresql/pgwatch3.git
cd pgwatch3/pgwatch3
./build_gatherer.sh
# after fetching all the Go library dependencies (can take minutes)
# an executable named "pgwatch3" should be generated. Additionally it's a good idea
# to copy it to /usr/bin/pgwatch3-daemon as that's what the default SystemD service expects.
</code></pre>
</li>
</ol>
</li>
</ul>
<blockquote>
<ul>
<li>
<p>Configure a SystemD auto-start service (optional)</p>
<p>Sample startup scripts can be found at
<em>/etc/pgwatch3/startup-scripts/pgwatch3.service</em> or online
<a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/pgwatch3/startup-scripts/pgwatch3.service">here</a>.
Note that they are OS agnostic and might need some light
adjustment of paths, etc - so always test them out.</p>
</li>
</ul>
</blockquote>
</li>
<li>
<p><strong>Boostrap the config DB</strong></p>
<ol>
<li>
<p>Create a user to "own" the pgwatch3 schema</p>
<p>Typically called <em>pgwatch3</em> but can be anything really, if the
schema creation file is adjusted accordingly.</p>
<pre><code>psql -c "create user pgwatch3 password 'xyz'"
psql -c "create database pgwatch3 owner pgwatch3"
</code></pre>
</li>
<li>
<p>Roll out the pgwatch3 config schema</p>
<p>The schema will most importantly hold connection strings of DB-s
to be monitored and the metric definitions.</p>
<pre><code># FYI - one could get the below schema files also directly from Github
# if re-using some existing remote Postgres instance where pgwatch3 was not installed
psql -f /etc/pgwatch3/sql/config_store/config_store.sql pgwatch3
psql -f /etc/pgwatch3/sql/config_store/metric_definitions.sql pgwatch3
</code></pre>
</li>
</ol>
</li>
</ol>
<p>::: {#metrics_db_bootstrap}
1.  <strong>Bootstrap the metrics storage DB</strong></p>
<pre><code>1.  Create a dedicated database for storing metrics and a user to
    "own" the metrics schema

    Here again default scripts expect a role named "pgwatch3" but
    can be anything if to adjust the scripts.

        psql -c "create database pgwatch3_metrics owner pgwatch3"

2.  Roll out the pgwatch3 metrics storage schema

    This is a place to pause and first think how many databases will
    be monitored, i.e. how much data generated, and based on that
    one should choose an according metrics storage schema. There are
    a couple of different options available that are described
    [here](https://github.com/cybertec-postgresql/pgwatch3/tree/master/pgwatch3/sql/metric_store)
    in detail, but the gist of it is that you don't want too
    complex partitioning schemes if you don't have zounds of data
    and don't need the fastest queries. For a smaller amount of
    monitored DBs (a couple dozen to a hundred) the default
    "metric-time" is a good choice. For hundreds of databases,
    aggressive intervals, or long term storage usage of the
    TimescaleDB extension is recommended.

        cd /etc/pgwatch3/sql/metric_store
        psql -f roll_out_metric_time.psql pgwatch3_metrics

    **Default retention for Postgres storage is 2 weeks!** To
    change, use the `--pg-retention-days / PW3_PG_RETENTION_DAYS`
    gatherer parameter.
</code></pre>
<ol>
<li>
<p><strong>Prepare the "to-be-monitored" databases for metrics collection</strong></p>
<p>As a minimum we need a plain unprivileged login user. Better though
is to grant the user also the <em>pg_monitor</em> system role, available on
v10+. Superuser privileges should be normally avoided for obvious
reasons of course, but for initial testing in safe environments it
can make the initial preparation (automatic <em>helper</em> rollouts) a bit
easier still, given superuser privileges are later stripped.</p>
<p>To get most out of your metrics some <em>SECURITY DEFINER</em> wrappers
functions called "helpers" are recommended on the DB-s under
monitoring. See the detailed chapter on the "preparation" topic
<code>here &lt;helper_functions&gt;</code>{.interpreted-text role="ref"} for more
details.</p>
</li>
<li>
<p><strong>Install Python 3 and start the Web UI (optional)</strong></p>
<p>The Web UI is not strictly required but makes life a lot easier for
<em>Config DB</em> based setups. Technically it would be fine also to
manage connection strings of the monitored DB-s directly in the
"pgwatch3.monitored_db" table and add/adjust metrics in the
"pgwatch3.metric" table, and <em>Preset Configs</em> in the
"pgwatch3.preset_config" table.</p>
<ol>
<li>
<p>Install Python 3 and Web UI requirements</p>
<pre><code># first we need Python 3 and "pip" - the Python package manager
sudo apt install python3 python3-pip
cd /etc/pgwatch3/webpy/
sudo pip3 install -U -r requirements_pg_metrics.txt
</code></pre>
</li>
<li>
<p>Exposing component logs (optional)</p>
<p>For use cases where exposing the component (Grafana, Postgres,
gatherer daemon, Web UI itself) logs over the "/logs" endpoint
remotely is wanted, then in the custom setup mode some actual
code changes are needed to specify where logs of all components
are situated - see top of the pgwatch3.py file for that.
Defaults are set to work with the Docker image.</p>
</li>
<li>
<p>Start the Web UI</p>
<pre><code># The defaults assume a local Config DB named pgwatch3, DB user pgwatch3
python3 web.py --datastore=postgres --pg-metric-store-conn-str="dbname=pgwatch3_metrics user=pgwatch3"
</code></pre>
<p>Default port for the Web UI: <strong>8080</strong>. See <code>web.py --help</code> for
all options.</p>
</li>
<li>
<p>Configure a SystemD auto-start service (optional)</p>
<p>Sample startup scripts can be found at
<em>/etc/pgwatch3/webpy/startup-scripts/pgwatch3-webui.service</em> or
online
<a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/webpy/startup-scripts/pgwatch3-webui.service">here</a>.
Note that they are OS agnostic and always need some light
adjustment of paths, etc - so always test them out.</p>
</li>
</ol>
</li>
<li>
<p><strong>Configure DB-s and metrics / intervals to be monitored</strong></p>
<ul>
<li>From the Web UI "/dbs" page</li>
<li>Via direct inserts into the Config DB <em>pgwatch3.monitored_db</em>
    table</li>
</ul>
</li>
<li>
<p><strong>Start the pgwatch3 metrics collection agent</strong></p>
<ol>
<li>
<p>The gatherer has quite some parameters (use the <em>--help</em> flag
    to show them all), but simplest form would be:</p>
<pre><code># default connections params expect a trusted localhost Config DB setup
# so mostly the 2nd line is not needed actually
pgwatch3-daemon \
  --host=localhost --user=pgwatch3 --dbname=pgwatch3 \
  --datastore=postgres --pg-metric-store-conn-str=postgresql://pgwatch3@localhost:5432/pgwatch3_metrics \
  --verbose=info

# or via SystemD if set up in step #2
useradd -m -s /bin/bash pgwatch3 # default SystemD templates run under the pgwatch3 user
sudo systemctl start pgwatch3
sudo systemctl status pgwatch3
</code></pre>
<p>After initial verification that all works it's usually good
idea to set verbosity back to default by removing the <em>verbose</em>
flag.</p>
<p>Another tip to configure connection strings inside SystemD
service files is to use the "systemd-escape" utility to escape
special characters like spaces etc if using the LibPQ connect
string syntax rather than JDBC syntax.</p>
</li>
<li>
<p>Monitor the console or log output for any problems</p>
<p>If you see metrics trickling into the "pgwatch3_metrics"
database (metric names are mapped to table names and tables are
auto-created), then congratulations - the deployment is working!
When using some more aggressive <em>preset metrics config</em> then
there are usually still some errors though, due to the fact that
some more extensions or privileges are missing on the monitored
database side. See the according chapter
<code>here &lt;preparing_databases&gt;</code>{.interpreted-text role="ref"}.</p>
</li>
</ol>
<p>When you're compiling your own gatherer then the executable file
will be named just <em>pgwatch3</em> instead of <em>pgwatch3-daemon</em> to avoid
mixups.
:::</p>
</li>
</ol>
<p>::: {#custom_install_grafana}
1.  <strong>Install Grafana</strong>
    1.  Create a Postgres database to hold Grafana internal config, like
        dashboards etc</p>
<pre><code>    Theoretically it's not absolutely required to use Postgres for
    storing Grafana internal settings / dashboards, but doing so has
    2 advantages - you can easily roll out all pgwatch3 built-in
    dashboards and one can also do remote backups of the Grafana
    configuration easily.

        psql -c "create user pgwatch3_grafana password 'xyz'"
        psql -c "create database pgwatch3_grafana owner pgwatch3_grafana"

2.  Follow the instructions from
    &lt;https://grafana.com/docs/grafana/latest/installation/debian/&gt;,
    basically something like:

        wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
        echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
        sudo apt-get update &amp;&amp; sudo apt-get install grafana

        # review / change config settings and security, etc
        sudo vi /etc/grafana/grafana.ini

        # start and enable auto-start on boot
        sudo systemctl daemon-reload
        sudo systemctl start grafana-server
        sudo systemctl status grafana-server

    Default Grafana port: 3000

3.  Configure Grafana config to use our pgwatch3_grafana DB

    Place something like below in the "\[database\]" section of
    /etc/grafana/grafana.ini

        [database]
        type = postgres
        host = my-postgres-db:5432
        name = pgwatch3_grafana
        user = pgwatch3_grafana
        password = xyz

    Taking a look at \[server\], \[security\] and \[auth\*\]
    sections is also recommended.

4.  Set up the pgwatch3 metrics database as the default datasource

    We need to tell Grafana where our metrics data is located. Add a
    datasource via the Grafana UI (Admin -\&gt; Data sources) or adjust
    and execute the "pgwatch3/bootstrap/grafana_datasource.sql"
    script on the *pgwatch3_grafana* DB.

5.  Add pgwatch3 predefined dashboards to Grafana

    This could be done by importing the pgwatch3 dashboard
    definition JSON-s manually, one by one, from the "grafana"
    folder ("Import Dashboard" from the Grafana top menu) or via
    as small helper script located at
    */etc/pgwatch3/grafana-dashboards/import_all.sh*. The script
    needs some adjustment for metrics storage type, connect data and
    file paths.

6.  Optionally install also Grafana plugins

    Currently one pre-configured dashboard (Biggest relations
    treemap) use an extra plugin - if planning to that dash, then
    run the following:

        grafana-cli plugins install savantly-heatmap-panel

7.  Start discovering the preset dashbaords

    If the previous step of launching pgwatch3 daemon succeeded and
    it was more than some minutes ago, one should already see some
    graphs on dashboards like "DB overview" or "DB overview
    Unprivileged / Developer mode" for example.
</code></pre>
<p>:::</p>
<h1 id="yaml-based-setup-yaml_setup">YAML based setup {#yaml_setup}</h1>
<p>From v1.4 one can also deploy the pgwatch3 gatherer daemons more easily
in a de-centralized way, by specifying monitoring configuration via YAML
files. In that case there is no need for a central Postgres "config
DB".</p>
<p><strong>YAML installation steps</strong></p>
<ol>
<li>Install pgwatch3 - either from pre-built packages or by compiling
    the Go code.</li>
<li>Specify hosts you want to monitor and with which metrics /
    aggressivness in a YAML file or files, following the example config
    located at <em>/etc/pgwatch3/config/instances.yaml</em> or online
    <a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/pgwatch3/config/instances.yaml">here</a>.
    Note that you can also use env. variables inside the YAML templates!</li>
<li>Bootstrap the metrics storage DB (not needed it using Prometheus
    mode).</li>
<li>Prepare the "to-be-monitored" databases for monitoring by creating
    a dedicated login role name as a
    <code>minimum &lt;preparing_databases&gt;</code>{.interpreted-text role="ref"}.</li>
<li>Run the pgatch2 gatherer specifying the YAML config file (or
    folder), and also the folder where metric definitions are located.
    Default location: <em>/etc/pgwatch3/metrics</em>.</li>
<li>Install and configure Grafana and import the pgwatch3 sample
    dashboards to start analyzing the metrics. See above for
    instructions.</li>
<li>Make sure that there are auto-start SystemD services for all
    components in place and optionally set up also backups.</li>
</ol>
<p>Relevant gatherer parameters / env. vars: <code>--config / PW3_CONFIG</code> and
<code>--metrics-folder / PW3_METRICS_FOLDER</code>.</p>
<p>For details on individual steps like installing pgwatch3 see the above
paragraph.</p>
<p>The Web UI component cannot be used in file based mode.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>