

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Components &mdash; pgwatch v2  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installation options" href="installation_options.html" />
    <link rel="prev" title="Advanced features" href="advanced_features.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pgwatch v2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_background.html">Project background</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">List of main features</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_features.html">Advanced features</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Components</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-metrics-gathering-daemon">The metrics gathering daemon</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-store">Configuration store</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metrics-storage-db">Metrics storage DB</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-web-ui">The Web UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#metrics-representation">Metrics representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#component-diagram">Component diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="#component-reuse">Component reuse</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation_options.html">Installation options</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_installation.html">Installing using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_installation.html">Custom installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="preparing_databases.html">Preparing databases for monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_managed_services.html">Monitoring managed cloud databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="metric_definitions.html">Metric definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="web_ui.html">The Admin Web UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboarding_alerting.html">Dashboarding and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="sizing_recommendations.html">Sizing recommendations</a></li>
<li class="toctree-l1"><a class="reference internal" href="technical_details.html">Technical details</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security aspects</a></li>
<li class="toctree-l1"><a class="reference internal" href="long_term_installations.html">Long term installations</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Kubernetes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pgwatch v2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Components</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/components.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This documentation pertains to older v2.x releases. 
Many features and functions have since been updated or replaced. 
Please refer to the <a class="reference external" href="https://pgwat.ch/">current version</a> 
for the latest information.</p>
</div>
<section id="components">
<span id="id1"></span><h1>Components<a class="headerlink" href="#components" title="Link to this heading"></a></h1>
<p>The main development idea around pgwatch2 was to do the minimal work needed and not to reinvent the wheel - meaning that
pgwatch2 is mostly just about gluing together already some proven pieces of software for metrics storage and using Grafana
for dashboarding. So here a listing of components that can be used to build up a monitoring setup around the pgwatch2
metrics collector. Note that most components are not mandatory and for tasks like metrics storage there are many components
to choose from.</p>
<section id="the-metrics-gathering-daemon">
<h2>The metrics gathering daemon<a class="headerlink" href="#the-metrics-gathering-daemon" title="Link to this heading"></a></h2>
<p>The metrics collector, written in Go, is the only mandatory and most critical component of the whole solution. The main
task of the pgwatch2 collector / daemon is pretty simple - reading the configuration and metric defintions, fetching the metrics
from the configured databases using the configured connection info and finally storing the metrics to some other
database, or just exposing them over a port for scraping in case of Prometheus mode.</p>
</section>
<section id="configuration-store">
<h2>Configuration store<a class="headerlink" href="#configuration-store" title="Link to this heading"></a></h2>
<p>The configuration says which databases, how often and with which metrics (SQL-s queries) are to be gathered.
There are 3 options to store the configuration:</p>
<blockquote>
<div><ul class="simple">
<li><p>A PostgreSQL database holding a simple schema with 5 tables.</p></li>
<li><p>File based approach - YAML config file(s) and SQL metric definition files.</p></li>
<li><p>Purely ENV based setup - i.e. an “ad-hoc” config to monitor a single database or the whole instance. Bascially just a
connect string (JDBC or Libpq type) is needed which is perfect for “throwaway” and Cloud / container usage.</p></li>
</ul>
</div></blockquote>
</section>
<section id="metrics-storage-db">
<h2>Metrics storage DB<a class="headerlink" href="#metrics-storage-db" title="Link to this heading"></a></h2>
<p>Many options here so that one can for example go for maximum storage effectiveness or pick something where they already
know the query language:</p>
<blockquote>
<div><ul>
<li><p><a class="reference external" href="https://www.influxdata.com/time-series-platform/influxdb/">InfluxDB</a> Time Series Database</p>
<p>InfluxDB is specifically designed for storing metrics so it’s disk footprint is much smaller compared to PostgreSQL
but downsides are the limited query capabilities and higher hardware (CPU / RAM) requirements - see the <a class="reference internal" href="sizing_recommendations.html#sizing-recommendations"><span class="std std-ref">Sizing recommendations</span></a> chapter for more details.</p>
</li>
<li><p><a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> - world’s most advanced Open Source RDBMS</p>
<p>Postgres storage is based on the JSONB datatype so minimally version 9.4+ is required, but for bigger setups where
partitioning is a must, v11+ is needed. Any already existing Postgres database will do the trick, see the <a class="reference internal" href="custom_installation.html#metrics-db-bootstrap"><span class="std std-ref">Bootstrapping the Metrics DB</span></a> section for2 details.</p>
</li>
<li><p><a class="reference external" href="https://www.timescale.com/">TimescaleDB</a> time-series extension for PostgreSQL</p>
<p>Although technically a plain extension it’s often mentioned as a separate database system as it brings custom data compression
to the table, enabling huge disk savings over standard Postgres. Note that pgwatch2 does not use Timescale’s built-in <em>retention</em>
management but a custom version.</p>
</li>
<li><p><a class="reference external" href="https://prometheus.io/">Prometheus</a> Time Series DB and monitoring system</p>
<p>Though Prometheus is not a traditional database system, it’s a good choice for monitoring Cloud-like environments as the
monitoring targets don’t need to know too much about how actual monitoring will be carried out later and also Prometheus
has a nice fault-tolerant alerting system for enterprise needs. NB! By default Prometheus is not set up for long term
metrics storage!</p>
</li>
<li><p><a class="reference external" href="https://graphiteapp.org/">Graphite</a> Time Series DB</p>
<p>Not as modern as the other options but a performant TSDB nevertheless with built-in charting. In pgwatch2 use case though
there’s no support for “custom tags” and request batching support which should not be a big problem for lighter use cases.</p>
</li>
<li><p>JSON files</p>
<p>Plain text files for testing / special use cases.</p>
</li>
</ul>
</div></blockquote>
</section>
<section id="the-web-ui">
<h2>The Web UI<a class="headerlink" href="#the-web-ui" title="Link to this heading"></a></h2>
<p>The second homebrewn component of the pgwatch2 solution is an optional and relatively simple Web UI for administering details
of the monitoring configuration like which databases should be monitored, with which metrics and intervals. Besides that there
are some basic overview tables to analyze the gathered data and also possibilities to delete unneeded metric data (when removing
a test host for example).</p>
<p>NB! Note that the Web UI can only be used if storing the configuration in the database (Postgres).</p>
</section>
<section id="metrics-representation">
<h2>Metrics representation<a class="headerlink" href="#metrics-representation" title="Link to this heading"></a></h2>
<p>Standard pgwatch2 setup uses <a class="reference external" href="http://grafana.org/">Grafana</a> for analyzing the gathered metrics data in a visual, point-and-click
way. For that a rich set of predefined dashboards for Postgres and InfluxDB data sources is provided, that should cover
the needs of most users - advanced users would mostly always want to customize some aspects though, so it’s not meant as
a one-size-fits-all solution. Also as metrics are stored in a DB, they can be visualized or processed in any other way.</p>
</section>
<section id="component-diagram">
<h2>Component diagram<a class="headerlink" href="#component-diagram" title="Link to this heading"></a></h2>
<p>Component diagram of a typical setup:</p>
<a class="reference external image-reference" href="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch2/master/screenshots/pgwatch2_architecture.png"><img alt="pgwatch2 typical deployment architecture diagram" src="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch2/master/screenshots/pgwatch2_architecture.png" />
</a>
</section>
<section id="component-reuse">
<span id="id2"></span><h2>Component reuse<a class="headerlink" href="#component-reuse" title="Link to this heading"></a></h2>
<p>NB! All components are <em>loosely coupled</em>, thus for non-pgwatch2 components (pgwatch2 components are only the metrics collector
and the optional Web UI) you can decide to make use of an already existing installation of Postgres, Grafana or InfluxDB
and run additionally just the pgwatch2 collector.</p>
<ul>
<li><p>To use an existing Postgres DB for storing the monitoring config</p>
<p>Create a new pgwatch2 DB, preferrably also an accroding role who owns it. Then roll out the schema (pgwatch2/sql/config_store/config_store.sql)
and set the following parameters when running the image: PW2_PGHOST, PW2_PGPORT, PW2_PGDATABASE, PW2_PGUSER, PW2_PGPASSWORD, PW2_PGSSL (optional).</p>
</li>
<li><p>To use an existing Grafana installation</p>
<p>Load the pgwatch2 dashboards from <em>grafana_dashboard</em> folder if needed (one can totally define their own) and set the following paramater: PW2_GRAFANA_BASEURL.
This parameter only provides correct links to Grafana dashboards from the Web UI. Grafana is the most loosely coupled component for pgwatch2
and basically doesn’t have to be used at all. One can make use of the gathered metrics directly over the Influx (or Graphite) API-s.</p>
</li>
<li><p>To use an existing InfluxDB installation</p>
<p>Set the following env variables: PW2_IHOST, PW2_IPORT, PW2_IDATABASE, PW2_IUSER, PW2_IPASSWORD, PW2_ISSL (optional).</p>
<p>NB! Note that if wanting to use SSL with self-signed certificates on InfluxDB side then some extra steps described in <a class="reference external" href="https://github.com/cybertec-postgresql/pgwatch2/issues/162">this</a>
Github issue are needed.</p>
</li>
<li><p>To use an existing Graphite installation</p>
<p>One can also store the metrics in Graphite instead of InfluxDB (no predefined pgwatch2 dashboards for Graphite though).
Following parameters needs to be set then: PW2_DATASTORE=graphite, PW2_GRAPHITEHOST, PW2_GRAPHITEPORT</p>
</li>
<li><p>To use an existing Postgres DB for storing metrics</p>
<ol class="arabic simple">
<li><p>Roll out the metrics storage schema according to instructions from <a class="reference internal" href="custom_installation.html#metrics-db-bootstrap"><span class="std std-ref">here</span></a>.</p></li>
<li><p>Following parameters need to be set for the gatherer:</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--datastore=postgres</span></code> or <code class="docutils literal notranslate"><span class="pre">PW2_DATASTORE=postgres</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pg-metric-store-conn-str=&quot;postgresql://user:pwd&#64;host:port/db&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">PW2_PG_METRIC_STORE_CONN_STR=&quot;...&quot;</span></code></p></li>
<li><p>optionally also adjust the <code class="docutils literal notranslate"><span class="pre">--pg-retention-days</span></code> parameter. By default 30 days for InfluxDB and 14 days for Postgres are kept</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>If using the Web UI also set the datastore parameters <code class="docutils literal notranslate"><span class="pre">--datastore</span></code> and <code class="docutils literal notranslate"><span class="pre">--pg-metric-store-conn-str</span></code> if wanting to
have an option to be able to clean up data also via the UI in a more targeted way.</p></li>
</ol>
<p>NB! When using Postgres metrics storage, the schema rollout script activates “asynchronous commiting” feature for the
<em>pgwatch2</em> role in the metrics storage DB by default! If this is not wanted (no metrics can be lost in case of a crash),
then re-enstate normal (synchronous) commiting with below query and restart the pgwatch2 agent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ALTER ROLE pgwatch2 IN DATABASE $MY_METRICS_DB SET synchronous_commit TO on;
</pre></div>
</div>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="advanced_features.html" class="btn btn-neutral float-left" title="Advanced features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="installation_options.html" class="btn btn-neutral float-right" title="Installation options" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, CYBERTEC PostgreSQL International GmBh.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>