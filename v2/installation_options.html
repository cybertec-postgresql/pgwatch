

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Installation options &mdash; pgwatch v2  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installing using Docker" href="docker_installation.html" />
    <link rel="prev" title="Components" href="components.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pgwatch v2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_background.html">Project background</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">List of main features</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_features.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="components.html">Components</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation options</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#config-db-based-operation">Config DB based operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#file-based-operation">File based operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ad-hoc-mode">Ad-hoc mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prometheus-mode">Prometheus mode</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="docker_installation.html">Installing using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_installation.html">Custom installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="preparing_databases.html">Preparing databases for monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_managed_services.html">Monitoring managed cloud databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="metric_definitions.html">Metric definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="web_ui.html">The Admin Web UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboarding_alerting.html">Dashboarding and alerting</a></li>
<li class="toctree-l1"><a class="reference internal" href="sizing_recommendations.html">Sizing recommendations</a></li>
<li class="toctree-l1"><a class="reference internal" href="technical_details.html">Technical details</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security aspects</a></li>
<li class="toctree-l1"><a class="reference internal" href="long_term_installations.html">Long term installations</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Kubernetes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pgwatch v2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Installation options</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation_options.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>This documentation pertains to older v2.x releases. 
Many features and functions have since been updated or replaced. 
Please refer to the <a class="reference external" href="https://pgwat.ch/">current version</a> 
for the latest information.</p>
</div>
<section id="installation-options">
<h1>Installation options<a class="headerlink" href="#installation-options" title="Link to this heading"></a></h1>
<p>Besides freedom of choosing from a set of metric storage options one can also choose how they’re going to retrieve metrics from databases
- in a “pull” or “push” way and how is the monitoring configuration (connect strings, metric sets and intervals) going to be stored.</p>
<section id="config-db-based-operation">
<h2>Config DB based operation<a class="headerlink" href="#config-db-based-operation" title="Link to this heading"></a></h2>
<p>This is the original central pull mode depicted on the <a class="reference internal" href="README.html#typical-architecture"><span class="std std-ref">architecture diagram</span></a>. It requires a
small schema to be rolled out on any Postgres database accessible to the metrics gathering daemon, which will hold the
connect strings, metric definition SQL-s and preset configurations and some other more minor attributes. For rollout details
see the <a class="reference internal" href="custom_installation.html#custom-installation"><span class="std std-ref">custom installation</span></a> chapter.</p>
<p>The default Docker images use this approach.</p>
</section>
<section id="file-based-operation">
<h2>File based operation<a class="headerlink" href="#file-based-operation" title="Link to this heading"></a></h2>
<p>From v1.4.0 one can deploy the gatherer daemon(s) decentrally with <em>hosts to be monitored</em> defined in simple YAML files.
In that case there is no need for the central Postgres “config DB”. See the sample <a class="reference external" href="https://github.com/cybertec-postgresql/pgwatch2/blob/master/pgwatch2/config/instances.yaml">instances.yaml</a>
config file for an example. Note that in this mode you also need to point out the path to metric definition SQL files
when starting the gatherer. Also note that the configuration system also supports multiple YAML files in a folder so that
you could easily programmatically manage things via <em>Ansible</em> for example and you can also use Env. vars in sideYAML files.</p>
<p>Relevant Gatherer env. vars / flags: <code class="docutils literal notranslate"><span class="pre">--config,</span> <span class="pre">--metrics-folder</span></code> or <code class="docutils literal notranslate"><span class="pre">PW2_CONFIG</span> <span class="pre">/</span> <span class="pre">PW2_METRICS_FOLDER</span></code>.</p>
</section>
<section id="ad-hoc-mode">
<span id="adhoc-mode"></span><h2>Ad-hoc mode<a class="headerlink" href="#ad-hoc-mode" title="Link to this heading"></a></h2>
<p>Optimized for Cloud scenarios and quick temporary setups, it’s also possible to run the metrics gathering daemon in a somewhat
limited “ad-hoc” mode, by specifying a single connection string via ENV or command line input, plus the same for the metrics
and intervals (as a JSON string) or a preset config name. In this mode it’s only possible to monitor a single specified Postgres DB
(the default behaviour) or the whole instance, i.e. all non-template databases found on the instance.</p>
<p>This mode is perfect also for Cloud setups in <em>sidecar</em> constellations when exposing the Prometheus output. Pushing to a central
metrics DB is also a good option for non-cloud setups if monitoring details like intervals etc are static enough - it helps to distribute
the metrics gathering load and is more fault-tolerant. The only critical component will then be the metrics storage DB, but that
can be well solved with a HA solution like Patroni for example.</p>
<p>Main benefit - in this mode there is no need for the central Postgres “config DB” nor any YAML config files.
NB! When using that mode with the default Docker image, the built-in metric definitions can’t be changed via the Web UI and it’s
actually recommended to use the <em>gatherer only</em> image named <em>cybertec/pgwatch2-daemon</em>.</p>
<p>Relevant Gatherer env. vars / flags: <code class="docutils literal notranslate"><span class="pre">--adhoc-conn-str,</span> <span class="pre">--adhoc-config,</span> <span class="pre">--adhoc-name,</span> <span class="pre">--metrics-folder</span></code> or respectively
<code class="docutils literal notranslate"><span class="pre">PW2_ADHOC_CONN_STR,</span> <span class="pre">PW2_ADHOC_CONFIG,</span> <span class="pre">PW2_ADHOC_NAME,</span> <span class="pre">PW2_METRICS_FOLDER,</span> <span class="pre">PW2_ADHOC_CREATE_HELPERS</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># launching in ad-hoc / test mode</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3000</span><span class="p">:</span><span class="mi">3000</span> <span class="o">-</span><span class="n">e</span> <span class="n">PW2_ADHOC_CONN_STR</span><span class="o">=</span><span class="s2">&quot;postgresql://user:pwd@mydb:5432/mydb1&quot;</span> \
    <span class="o">-</span><span class="n">e</span> <span class="n">PW2_ADHOC_CONFIG</span><span class="o">=</span><span class="n">unprivileged</span> <span class="o">--</span><span class="n">name</span> <span class="n">pw2</span> <span class="n">cybertec</span><span class="o">/</span><span class="n">pgwatch2</span><span class="o">-</span><span class="n">postgres</span>

<span class="c1"># launching in ad-hoc / test mode, creating metrics helpers automatically (requires superuser)</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3000</span><span class="p">:</span><span class="mi">3000</span> <span class="o">-</span><span class="n">e</span> <span class="n">PW2_ADHOC_CONN_STR</span><span class="o">=</span><span class="s2">&quot;postgresql://user:pwd@mydb:5432/mydb1&quot;</span> \
    <span class="o">-</span><span class="n">e</span> <span class="n">PW2_ADHOC_CONFIG</span><span class="o">=</span><span class="n">exhaustive</span> <span class="o">-</span><span class="n">e</span> <span class="n">PW2_ADHOC_CREATE_HELPERS</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="n">name</span> <span class="n">pw2</span> <span class="n">cybertec</span><span class="o">/</span><span class="n">pgwatch2</span><span class="o">-</span><span class="n">postgres</span>
</pre></div>
</div>
<p>NB! Using the <code class="docutils literal notranslate"><span class="pre">PW2_ADHOC_CREATE_HELPERS</span></code> flag will try to create all metrics fetching helpers automatically if not already
existing - this assumes superuser privileges though, which is not recommended for long term setups for obvious reasons.
In case a long term need rises it’s recommended to change the monitoring role to an unprivileged <em>pgwatch2</em> user, which
by default gets execute <em>GRANT</em>-s to all helper functions. More details on how to deal with <em>helpers</em> can be found <a class="reference internal" href="preparing_databases.html#helper-functions"><span class="std std-ref">here</span></a>
and more on secure setups in the <a class="reference internal" href="security.html#security"><span class="std std-ref">security chapter</span></a>.</p>
</section>
<section id="prometheus-mode">
<h2>Prometheus mode<a class="headerlink" href="#prometheus-mode" title="Link to this heading"></a></h2>
<p>In v1.6.0 was added support for Prometheus - being one of the most popular modern metrics gathering / alerting solutions.
When the <code class="docutils literal notranslate"><span class="pre">--datastore</span> <span class="pre">/</span> <span class="pre">PW2_DATASTORE</span></code> parameter is set to <em>prometheus</em> then the pgwatch2 metrics collector doesn’t do any normal interval-based fetching but
listens on port <em>9187</em> (changeable) for scrape requests configured and performed on Prometheus side. Returned metrics belong
to the “pgwatch2” namespace (a prefix basically) which is changeable via the <code class="docutils literal notranslate"><span class="pre">--prometheus-namespace</span></code> flag if needed.</p>
<p>Also important to note - in this mode the pgwatch2 agent should not be run centrally but on all individual DB hosts. While
technically possible though to run centrally, it would counter the core idea of Prometheus and would make scrapes also longer
and risk getting timeouts as all DBs are scanned sequentially for metrics.</p>
<p>FYI – the functionality has some overlap with the existing <a class="reference external" href="https://github.com/wrouesnel/postgres_exporter">postgres_exporter</a>
project, but also provides more flexibility in metrics configuration and all config changes are applied “online”.</p>
<p>Also note that Prometheus can only store numerical metric data values - so metrics output for example PostgreSQL storage and Prometheus
are not 100% compatile. Due to that there’s also a separate “preset config” named “prometheus”.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="components.html" class="btn btn-neutral float-left" title="Components" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="docker_installation.html" class="btn btn-neutral float-right" title="Installing using Docker" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, CYBERTEC PostgreSQL International GmBh.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>