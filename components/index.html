
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pgwatch.com/docs/components/">
      
      
        <link rel="prev" href="../advanced_features/">
      
      
        <link rel="next" href="../installation_options/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.29">
    
    
      
        <title>Components - pgwatch3 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.76a95c52.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-metrics-gathering-daemon" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pgwatch3 Documentation" class="md-header__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pgwatch3 Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Components
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pgwatch3 Documentation" class="md-nav__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pgwatch3 Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../project_background/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project Background
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced_features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation_options/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation Options
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker_installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom_installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../preparing_databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preparing Databases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../using_managed_services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Managed Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metric_definitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metric Definitions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../web_ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web UI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboarding_alerting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashboarding and Alerting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sizing_recommendations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sizing Recommendations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../technical_details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical Details
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../long_term_installations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Long Term Installations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrading
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>The main development idea around pgwatch3 was to do the minimal work
needed and not to reinvent the wheel - meaning that pgwatch3 is mostly
just about gluing together already some proven pieces of software for
metrics storage and using Grafana for dashboarding. So here a listing of
components that can be used to build up a monitoring setup around the
pgwatch3 metrics collector. Note that most components are not mandatory
and for tasks like metrics storage there are many components to choose
from.</p>
<h1 id="the-metrics-gathering-daemon">The metrics gathering daemon</h1>
<p>The metrics collector, written in Go, is the only mandatory and most
critical component of the whole solution. The main task of the pgwatch3
collector / daemon is pretty simple - reading the configuration and
metric defintions, fetching the metrics from the configured databases
using the configured connection info and finally storing the metrics to
some other database, or just exposing them over a port for scraping in
case of Prometheus mode.</p>
<h1 id="configuration-store">Configuration store</h1>
<p>The configuration says which databases, how often and with which metrics
(SQL-s queries) are to be gathered. There are 3 options to store the
configuration:</p>
<ul>
<li>A PostgreSQL database holding a simple schema with 5 tables.</li>
<li>File based approach - YAML config file(s) and SQL metric definition files.</li>
</ul>
<h1 id="metrics-storage-db">Metrics storage DB</h1>
<p>Many options here so that one can for example go for maximum storage
effectiveness or pick something where they already know the query
language:</p>
<ul>
<li><a href="https://www.postgresql.org/">PostgreSQL</a> - world's most advanced
Open Source RDBMS</li>
</ul>
<p>Postgres storage is based on the JSONB datatype so minimally
version 9.4+ is required, but for bigger setups where partitioning
is a must, v11+ is needed. Any already existing Postgres database
will do the trick, see the <a href="metrics_db_bootstrap">Bootstrapping the Metrics DB</a> section for2 details.</p>
<ul>
<li><a href="https://www.timescale.com/">TimescaleDB</a> time-series extension<blockquote>
<pre><code>for PostgreSQL

Although technically a plain extension it's often mentioned as a
separate database system as it brings custom data compression to
the table, enabling huge disk savings over standard Postgres. Note
that pgwatch3 does not use Timescale's built-in *retention*
management but a custom version.
</code></pre>
</blockquote>
</li>
<li><a href="https://prometheus.io/">Prometheus</a> Time Series DB and monitoring<blockquote>
<pre><code>system

Though Prometheus is not a traditional database system, it's a
good choice for monitoring Cloud-like environments as the
monitoring targets don't need to know too much about how actual
monitoring will be carried out later and also Prometheus has a
nice fault-tolerant alerting system for enterprise needs. By
default Prometheus is not set up for long term metrics storage!
</code></pre>
</blockquote>
</li>
<li><a href="https://graphiteapp.org/">Graphite</a> Time Series DB<blockquote>
<pre><code>Not as modern as the other options but a performant TSDB
nevertheless with built-in charting. In pgwatch3 use case though
there's no support for "custom tags" and request batching
support which should not be a big problem for lighter use cases.
</code></pre>
</blockquote>
</li>
<li>JSON files<blockquote>
<pre><code>Plain text files for testing / special use cases.
</code></pre>
</blockquote>
</li>
</ul>
<h1 id="the-web-ui">The Web UI</h1>
<p>The second homebrewn component of the pgwatch3 solution is an optional
and relatively simple Web UI for administering details of the monitoring
configuration like which databases should be monitored, with which
metrics and intervals. Besides that there are some basic overview tables
to analyze the gathered data and also possibilities to delete unneeded
metric data (when removing a test host for example).</p>
<p>Note that the Web UI can only be used if storing the configuration in
the database (Postgres).</p>
<h1 id="metrics-representation">Metrics representation</h1>
<p>Standard pgwatch3 setup uses <a href="http://grafana.org/">Grafana</a> for
analyzing the gathered metrics data in a visual, point-and-click way.
For that a rich set of predefined dashboards for Postgres is provided,
that should cover the needs of most users - advanced users would mostly
always want to customize some aspects though, so it's not meant as a
one-size-fits-all solution. Also as metrics are stored in a DB, they can
be visualized or processed in any other way.</p>
<h1 id="component-diagram">Component diagram</h1>
<p>Component diagram of a typical setup:</p>
<p><a href="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgwatch3_architecture.png"><img alt="pgwatch3 typical deployment architecture diagram" src="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgwatch3_architecture.png" /></a></p>
<h1 id="component-reuse-component_reuse">Component reuse {#component_reuse}</h1>
<p>All components are <em>loosely coupled</em>, thus for non-pgwatch3 components
(pgwatch3 components are only the metrics collector and the optional Web
UI) you can decide to make use of an already existing installation of
Postgres, Grafana or Prometheus and run additionally just the pgwatch3
collector.</p>
<ul>
<li>
<p>To use an existing Postgres DB for storing the monitoring config</p>
<p>Create a new pgwatch3 DB, preferrably also an accroding role who
owns it. Then roll out the schema
(pgwatch3/sql/config_store/config_store.sql) and set the following
parameters when running the image: PW3_PGHOST, PW3_PGPORT,
PW3_PGDATABASE, PW3_PGUSER, PW3_PGPASSWORD, PW3_PGSSL (optional).</p>
</li>
<li>
<p>To use an existing Grafana installation</p>
<p>Load the pgwatch3 dashboards from <em>grafana_dashboard</em> folder if
needed (one can totally define their own) and set the following
paramater: PW3_GRAFANA_BASEURL. This parameter only provides correct
links to Grafana dashboards from the Web UI. Grafana is the most
loosely coupled component for pgwatch3 and basically doesn't have
to be used at all. One can make use of the gathered metrics directly
over the Postgres (or Graphite) API-s.</p>
</li>
<li>
<p>To use an existing Graphite installation</p>
<p>One can also store the metrics in Graphite instead of Postgres (no
predefined pgwatch3 dashboards for Graphite though). Following
parameters needs to be set then: PW3_DATASTORE=graphite,
PW3_GRAPHITEHOST, PW3_GRAPHITEPORT</p>
</li>
<li>
<p>To use an existing Postgres DB for storing metrics</p>
<ol>
<li>Roll out the metrics storage schema according to instructions
    from <code>here &lt;metrics_db_bootstrap&gt;</code>{.interpreted-text
    role="ref"}.</li>
<li>Following parameters need to be set for the gatherer:</li>
</ol>
<blockquote>
<ul>
<li><code>--datastore=postgres</code> or <code>PW3_DATASTORE=postgres</code></li>
<li><code>--pg-metric-store-conn-str="postgresql://user:pwd@host:port/db"</code>
    or <code>PW3_PG_METRIC_STORE_CONN_STR="..."</code></li>
<li>optionally also adjust the <code>--pg-retention-days</code> parameter. By
    default 14 days for Postgres are kept</li>
</ul>
</blockquote>
<ol>
<li>If using the Web UI also set the datastore parameters
    <code>--datastore</code> and <code>--pg-metric-store-conn-str</code> if wanting to
    have an option to be able to clean up data also via the UI in a
    more targeted way.</li>
</ol>
<p>When using Postgres metrics storage, the schema rollout script
activates "asynchronous commiting" feature for the <em>pgwatch3</em> role
in the metrics storage DB by default! If this is not wanted (no
metrics can be lost in case of a crash), then re-enstate normal
(synchronous) commiting with below query and restart the pgwatch3
agent:</p>
<pre><code>ALTER ROLE pgwatch3 IN DATABASE $MY_METRICS_DB SET synchronous_commit TO on;
</code></pre>
</li>
</ul>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>