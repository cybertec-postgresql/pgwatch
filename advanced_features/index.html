
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pgwatch.com/docs/advanced_features/">
      
      
        <link rel="prev" href="../features/">
      
      
        <link rel="next" href="../components/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.29">
    
    
      
        <title>Advanced features - pgwatch3 Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.76a95c52.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#patroni-support" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pgwatch3 Documentation" class="md-header__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pgwatch3 Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced features
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pgwatch3 Documentation" class="md-nav__button md-logo" aria-label="pgwatch3 Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pgwatch3 Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../project_background/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project Background
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Advanced Features
  </span>
  

      </a>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation_options/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation Options
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker_installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom_installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../preparing_databases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preparing Databases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../using_managed_services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Managed Services
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../metric_definitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metric Definitions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../web_ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web UI
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dashboarding_alerting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashboarding and Alerting
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sizing_recommendations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sizing Recommendations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../technical_details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Technical Details
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../long_term_installations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Long Term Installations
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrading
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>Over the years the core functionality of fetching metrics from a set of
plain Postgres DB-s has been extended in many ways to cover some common
problem areas like server log monitoring and supporting monitoring of
some other popular tools often used together with Postgres, like the
PgBouncer connection pooler for example.</p>
<h1 id="patroni-support">Patroni support</h1>
<p>Patroni is a popular Postgres specific HA-cluster manager that makes
node management simpler than ever, meaning that everything is dynamic
though - cluster members can come and go, making monitoring in the
standard way a bit tricky. But luckily Patroni cluster members
information is stored in a DCS (Distributed Consensus Store), like
<em>etcd</em>, so it can be fetched from there periodically.</p>
<p>When 'patroni' is selected as <code>DB type &lt;db_types&gt;</code>{.interpreted-text
role="ref"} then the usual Postgres host/port fields should be left
empty ("dbname" can still filled if only a specific single database is
to be monitored) and instead "Host config" JSON field should be filled
with DCS address, type and scope (cluster name) information. A sample
config (for Config DB based setups) looks like:</p>
<pre><code class="language-json">    {
      &quot;dcs_type&quot;: &quot;etcd&quot;,
      &quot;dcs_endpoints&quot;: [&quot;http://127.0.0.1:2379&quot;],
      &quot;scope&quot;: &quot;batman&quot;,
      &quot;namespace&quot;: &quot;/service/&quot;
    }
</code></pre>
<p>For YAML based setups an example can be found from the
<a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/pgwatch3/config/instances.yaml#L34">instances.yaml</a>
file.</p>
<p>If Patroni is powered by <em>etcd</em>, then also username, password, ca_file,
cert_file, key_file optional security parameters can be defined - other
DCS systems are currently only supported without authentication.</p>
<p>Also if you don't use the standby nodes actively for queries then it
might make sense to decrease the volume of gathered metrics and to
disable the monitoring of such nodes with the "Master mode only?"
checkbox (when using the Web UI) or with <em>only_if_master=true</em> if using
a YAML based setup.</p>
<h1 id="log-parsing-log_parsing">Log parsing {#log_parsing}</h1>
<p>As of v1.7.0 the metrics collector daemon, when running on a DB server
(controlled best over a YAML config), has capabilities to parse the
database server logs for errors. Out-of-the-box it will though only work
when logs are written in <strong>CSVLOG</strong> format. For other formats user needs
to specify a regex that parses out named groups of following fields:
<em>database_name</em>, <em>error_severity</em>. See
<a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/pgwatch3/logparse.go#L27">here</a>
for an example regex.</p>
<p>Note that only the event counts are stored, no error texts, usernames or
other infos! Errors are grouped by severity for the monitored DB and for
the whole instance. The metric name to enable log parsing is
"server_log_event_counts". Also note that for auto-detection of log
destination / setting to work, the monitoring user needs superuser /
pg_monitor privileges - if this is not possible then log settings need
to be specified manually under "Host config" as seen for example
<a href="https://github.com/cybertec-postgresql/pgwatch3/blob/master/pgwatch3/config/instances.yaml">here</a>.</p>
<p><strong>Sample configuration if not using CSVLOG logging:</strong></p>
<p>On Postgres side (on the monitored DB)</p>
<pre><code>    # Debian / Ubuntu default log_line_prefix actually
    log_line_prefix = '%m [%p] %q%u@%d '
</code></pre>
<p>YAML config (recommended when "pushing" metrics from DB nodes to a
central metrics DB)</p>
<pre><code>    ## logs_glob_path is only needed if the monitoring user is cannot auto-detect it (i.e. not a superuser / pg_monitor role)
    # logs_glob_path:
    logs_match_regex: '^(?P&lt;log_time&gt;.*) \[(?P&lt;process_id&gt;\d+)\] (?P&lt;user_name&gt;.*)@(?P&lt;database_name&gt;.*?) (?P&lt;error_severity&gt;.*?): '
</code></pre>
<p>For log parsing to work the metric <strong>server_log_event_counts</strong> needs to
be enabled or a <em>preset config</em> including it used - like the "full"
preset.</p>
<h1 id="pgbouncer-support">PgBouncer support</h1>
<p>pgwatch3 also supports collecting internal statistics from the PgBouncer
connection pooler, via the built-in special "pgbouncer" database and
the <code>SHOW STATS</code> command. To enable it choose the according <em>DB Type</em>,
provide connection info to the pooler port and make sure the
<strong>pgbouncer_stats</strong> metric or "pgbouncer" preset config is selected
for the host. Note that for the "DB Name" field you should insert not
"pgbouncer" (although this special DB provides all the statistics) but
the real name of the pool you wish to monitor or leave it empty to track
all pools. In latter case individual pools will be identified /
separated via the "database" tag.</p>
<p>There's also a built-in Grafana dashboard for PgBouncer data, looking
like that:</p>
<p><a href="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgbouncer_stats.png"><img alt="Grafana dash for PgBouncer stats" src="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgbouncer_stats.png" /></a></p>
<h1 id="pgpool-ii-support">Pgpool-II support</h1>
<p>Quite similar to PgBouncer, also Pgpool offers some statistics on pool
performance and status, which might be of interest especially if using
the load balancing features. To enable it choose the according <em>DB
Type</em>, provide connection info to the pooler port and make sure the
<strong>pgpool_stats</strong> metric / preset config is selected for the host.</p>
<p>The built-in Grafana dashboard for Pgpool data looks something like
that:</p>
<p><a href="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgpool_status.png"><img alt="Grafana dash for PgPool stats" src="https://raw.githubusercontent.com/cybertec-postgresql/pgwatch3/master/docs/screenshots/pgpool_status.png" /></a></p>
<h1 id="prometheus-scraping">Prometheus scraping</h1>
<p>pgwatch3 was originally designed with direct metrics storage in mind,
but later also support for externally controlled
<a href="https://prometheus.io/">Prometheus</a> scraping was added. Note that
currently though the storage modes are exclusive, i.e. when you enable
the Promotheus endpoint (default port 9187) there will be no direct
metrics storage.</p>
<p>To enable the scraping endpoint set <code>--datastore=prometheus</code> and
optionally also <code>--prometheus-port</code>, <code>--prometheus-namespace</code>,
<code>--prometheus-listen-addr</code>. Additionally note that you still need to
specify some metrics config as usually - only metrics with interval
values bigger than zero will be populated on scraping.</p>
<p>Currently a few built-in metrics that require some state to be stored
between scrapes, e.g. the "change_events" metric, will currently be
ignored. Also non-numeric data columns will be ignored! Tag columns will
be preserved though as Prometheus "labels".</p>
<h1 id="aws-azure-gce-support">AWS / Azure / GCE support</h1>
<p>Due to popularity of various managed PostgreSQL offerings there's also
support for some managed options in sense of <em>Preset Configs</em>, that take
into account the fact that on such platforms you get a limited user that
doesn't have access to all metrics or some features have just been
plain removed. Thus to reduce server log errors and save time on
experimenting there are following presets available:</p>
<ul>
<li><strong>aws</strong> - for standard AWS RDS managed PostgreSQL databases</li>
<li><strong>aurora</strong> - for AWS Aurora managed PostgreSQL service</li>
<li><strong>azure</strong> - for Azure Database for PostgreSQL managed databases</li>
<li><strong>gce</strong> - for Google Cloud SQL for PostgreSQL managed databases</li>
</ul>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>